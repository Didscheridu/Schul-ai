name: Deploy Web App

# Wann soll das passieren? (Bei jedem Push auf "main")
on:
  push:
    branches: ["main"]
  # Erlaubt dir, es auch manuell im "Actions" Tab zu starten
  workflow_dispatch:

# Berechtigungen, damit GitHub die Seite online stellen darf
permissions:
  contents: read
  pages: write
  id-token: write

# Verhindert, dass sich mehrere Updates überschneiden
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      # 1. Code herunterladen
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. GitHub Pages vorbereiten
      - name: Setup Pages
        uses: actions/configure-pages@v5

      # 3. API Key einfügen (Der wichtigste Schritt!)
      # Er sucht nach "__GEMINI_API_KEY__" in der index.html und ersetzt es.
      - name: Inject API Key
        env:
          # Hier holen wir den Key aus den Secrets
          THE_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$THE_KEY" ]; then
            echo "WARNUNG: Das Secret GEMINI_API_KEY wurde nicht gefunden!"
            echo "Bitte gehe zu Settings -> Secrets and variables -> Actions und erstelle es."
          else
            # Wir benutzen Pipe | als Trennzeichen, falls der Key Schrägstriche enthält
            sed -i "s|__GEMINI_API_KEY__|$THE_KEY|g" index.html
            echo "Erfolg: Platzhalter wurde durch echten Key ersetzt."
          fi

      # 4. Webseite hochladen
      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # '.' bedeutet: Nimm den aktuellen Ordner (wo die index.html liegt)
          path: '.'

      # 5. Veröffentlichen
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
