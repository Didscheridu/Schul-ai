<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>SchulSim AI 4.6 (GitHub Secrets)</title>
    
    <!-- Styles & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PPTX Gen -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }
        @keyframes gradient-xy { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .animate-gradient-xy { background-size: 200% 200%; animation: gradient-xy 15s ease infinite; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .h-dvh { height: 100dvh; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 m-0 p-0 overscroll-none">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // KONFIGURATION (GitHub Secrets Mode)
        // ==========================================
        
        // Dieser Platzhalter wird von der GitHub Action ersetzt!
        // Wenn du lokal testest, kannst du hier deinen Key eintragen.
        const injectedKey = "%VITE_GEMINI_API_KEY%"; 
        
        // ==========================================

        // --- IMPORTS ---
        const { useState, useEffect, useRef } = React;

        // --- INLINE ICONS ---
        const Icon = ({ children, size = 24, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Icons = {
            GraduationCap: (p) => <Icon {...p}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></Icon>,
            Brain: (p) => <Icon {...p}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></Icon>,
            Languages: (p) => <Icon {...p}><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></Icon>,
            PenTool: (p) => <Icon {...p}><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></Icon>,
            Presentation: (p) => <Icon {...p}><path d="M2 3h20"/><path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"/><path d="m7 21 5-5 5 5"/></Icon>,
            CheckCircle: (p) => <Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>,
            XCircle: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></Icon>,
            Upload: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></Icon>,
            Play: (p) => <Icon {...p}><polygon points="5 3 19 12 5 21 5 3"/></Icon>,
            BookOpen: (p) => <Icon {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></Icon>,
            StickyNote: (p) => <Icon {...p}><path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/></Icon>,
            ChevronRight: (p) => <Icon {...p}><path d="m9 18 6-6-6-6"/></Icon>,
            ChevronLeft: (p) => <Icon {...p}><path d="m15 18-6-6 6-6"/></Icon>,
            Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>,
            RefreshCw: (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>,
            ImageIcon: (p) => <Icon {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></Icon>,
            Send: (p) => <Icon {...p}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></Icon>,
            Mic: (p) => <Icon {...p}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></Icon>,
            Sparkles: (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/></Icon>,
            Pencil: (p) => <Icon {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></Icon>,
            Scale: (p) => <Icon {...p}><path d="m16 16 3-8 3 8c-.87.65-1.926 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.926 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></Icon>,
            FileText: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></Icon>,
            Lock: (p) => <Icon {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>,
            FileCheck: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></Icon>,
            Shield: (p) => <Icon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></Icon>,
            UserCheck: (p) => <Icon {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></Icon>,
            Cookie: (p) => <Icon {...p}><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"/><path d="M8.5 8.5v.01"/><path d="M16 15.5v.01"/><path d="M12 12v.01"/><path d="M11 17v.01"/><path d="M7 14v.01"/></Icon>,
            AlertTriangle: (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></Icon>,
            Globe: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></Icon>,
            Key: (p) => <Icon {...p}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></Icon>
        };

        // --- DESIGNS ---
        const DESIGNS = {
            modern: { name: 'Modern (Blau)', bg: 'bg-white', text: 'text-slate-800', accent: 'text-blue-600', border: 'border-slate-200', font: 'font-sans', transition: 'fade' },
            business: { name: 'Business (Grau)', bg: 'bg-slate-100', text: 'text-slate-900', accent: 'text-slate-600', border: 'border-slate-300', font: 'font-sans', transition: 'fade' },
            chalkboard: { name: 'Tafel (Grün)', bg: 'bg-emerald-900', text: 'text-white', accent: 'text-yellow-400', border: 'border-yellow-700/50', font: 'font-serif', transition: 'push' },
            cyber: { name: 'Cyber (Neon)', bg: 'bg-slate-950', text: 'text-cyan-400', accent: 'text-fuchsia-500', border: 'border-cyan-500/50', font: 'font-mono', transition: 'zoom' },
            book: { name: 'Buch (Antik)', bg: 'bg-amber-50', text: 'text-stone-800', accent: 'text-amber-900', border: 'border-stone-300', font: 'font-serif', transition: 'cover' },
            geometric: { name: 'Geometrisch (Lila)', bg: 'bg-indigo-50', text: 'text-indigo-900', accent: 'text-indigo-600', border: 'border-indigo-200', font: 'font-sans', transition: 'fade' },
            space: { name: 'Weltraum (Dunkel)', bg: 'bg-[#0B0D17]', text: 'text-slate-200', accent: 'text-indigo-400', border: 'border-indigo-900', font: 'font-sans', transition: 'zoom' },
        };

        // --- TYPEWRITER ---
        const Typewriter = ({ text }) => {
            const [display, setDisplay] = useState('');
            useEffect(() => {
                setDisplay('');
                if (!text) return;
                let i = 0;
                const timer = setInterval(() => {
                    if (i < text.length) { setDisplay(prev => prev + text.charAt(i)); i++; }
                    else clearInterval(timer);
                }, 5);
                return () => clearInterval(timer);
            }, [text]);
            return <span className="whitespace-pre-wrap">{display.split('**').map((s,i) => i%2===1 ? <strong key={i} className="text-indigo-400">{s}</strong> : s)}</span>;
        };

        // --- HELPER: URL to Base64 (for AI check) ---
        const urlToBase64 = async (url) => {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                console.error("Bild Konvertierung fehlgeschlagen", e);
                return null;
            }
        };

        // --- API HELPERS ---
        const verifyImageWithAI = async (imageUrl, topic, key) => {
            if (!key) return true;
            const base64 = await urlToBase64(imageUrl);
            if (!base64) return true; 

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [
                                { text: `Analysiere dieses Bild. Prüfe zwei Dinge: 1. Passt es thematisch zu "${topic}"? 2. Ist das Bild sicher und kindgerecht (Schulkontext)? Antworte NUR mit JA, wenn BEIDES zutrifft. Wenn es unpassend ist, antworte mit NEIN.` },
                                { inlineData: { mimeType: "image/jpeg", data: base64 } }
                            ]
                        }]
                    })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text?.toUpperCase() || "";
                console.log(`Bild-Check für '${topic}': ${text}`);
                return text.includes("JA");
            } catch (e) { return true; }
        };

        const searchInternetImageSmart = async (query, onStatus, key) => {
            const cleanQuery = query.replace(/bild von|foto von|picture of|image of/gi, '').trim();
            const url = `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrnamespace=6&gsrsearch=${encodeURIComponent(cleanQuery)}&gsrlimit=5&prop=imageinfo&iiprop=url&format=json&origin=*`;

            try {
                if (onStatus) onStatus("Suche Bilder im Web...");
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.query && data.query.pages) {
                    const pages = Object.values(data.query.pages);
                    for (let i = 0; i < Math.min(pages.length, 3); i++) {
                        if (pages[i].imageinfo && pages[i].imageinfo[0].url) {
                            const candidateUrl = pages[i].imageinfo[0].url;
                            if (onStatus) onStatus(`Prüfe Bild ${i+1} auf Eignung...`);
                            const isValid = await verifyImageWithAI(candidateUrl, cleanQuery, key);
                            if (isValid) {
                                if (onStatus) onStatus(null);
                                return candidateUrl;
                            }
                        }
                    }
                    if (pages[0].imageinfo && pages[0].imageinfo[0].url) return pages[0].imageinfo[0].url;
                }
            } catch (e) { console.error("Web Search Error", e); }

            return `https://image.pollinations.ai/prompt/${encodeURIComponent(cleanQuery)}?width=800&height=600&nologo=true`;
        };

        const generateContent = async (history, prompt, imageData, mode, key) => {
            if (!key) return "FEHLER: Bitte trage zuerst deinen API Key ein!";

            const parts = [{ text: prompt }];
            if (imageData) parts.push({ inlineData: { mimeType: "image/png", data: imageData } });

            const systemPrompt = mode === 'presentation'
                ? `Erstelle eine JSON-Struktur für eine Schulpräsentation. 
                   Format: [{"title": "...", "content": ["Punkt 1", "Punkt 2"], "layout": "image_right", "imagePrompt": "...", "flashcard": "..."}]. 
                   Layouts: "image_right", "image_left", "title_only". 
                   WICHTIG: "flashcard" muss ein fließender Sprechertext sein.
                   KEIN Markdown, NUR reines JSON.`
                : `Du bist "Herr Lehrer", ein hilfreicher KI-Tutor. Modus: ${mode}.
                   Formatierung: Nutze Absätze, Listen (-) und **Fettgedrucktes**.
                   VERBOTEN: LaTeX ($$). Schreibe Mathe einfach (x^2, wurzel aus).`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: systemPrompt }] }, ...history, { role: "user", parts }] })
                });
                if (!response.ok) return "Verbindungsfehler oder ungültiger API Key.";
                const data = await response.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) return "Keine Antwort erhalten.";
                
                text = text.replace(/\$\$/g, '').replace(/\\\[/g, '').replace(/\\\]/g, ''); 

                if (mode === 'presentation') {
                    text = text.replace(/```json|```/g, '').trim();
                    const jsonMatch = text.match(/\[[\s\S]*\]/);
                    if (jsonMatch) text = jsonMatch[0];
                }
                return text;
            } catch (e) { return "Netzwerkfehler."; }
        };

        const generateImage = async (prompt, source = 'art', key) => {
            const stylePrompt = source === 'web' 
                ? "photorealistic, 4k"
                : "vector illustration, flat design";
            const fullPrompt = `Subject: ${prompt}. Style: ${stylePrompt}`;

            if (key) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${key}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ instances: [{ prompt: fullPrompt }], parameters: { sampleCount: 1 } })
                    });
                    const data = await response.json();
                    if (data.predictions?.[0]?.bytesBase64Encoded) {
                        return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    }
                } catch (e) { console.warn("Fallback..."); }
            }
            const safePrompt = encodeURIComponent(prompt.substring(0, 50));
            return `https://image.pollinations.ai/prompt/${safePrompt}%20${encodeURIComponent(stylePrompt)}?width=1024&height=768&nologo=true`;
        };

        // --- APP COMPONENT ---
        const App = () => {
            // Priority: Injected Key > Local Storage
            const [localApiKey, setLocalApiKey] = useState(() => {
                if (injectedKey && injectedKey !== "%" + "VITE_GEMINI_API_KEY" + "%" && injectedKey !== "REPLACE_WITH_SECRET_KEY") return injectedKey;
                return localStorage.getItem('gemini_key') || "";
            });
            
            const [view, setView] = useState("intro");
            const [mode, setMode] = useState("explain");
            const [topic, setTopic] = useState("");
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            
            const [vocabFile, setVocabFile] = useState(null);
            const [homeworkFile, setHomeworkFile] = useState(null);
            
            const [slides, setSlides] = useState([]);
            const [slideIdx, setSlideIdx] = useState(0);
            const [presSettings, setPresSettings] = useState({ count: 5, design: 'modern', source: 'web', teacherMode: true });
            const [presLoadingProgress, setPresLoadingProgress] = useState(null); 
            const [currentImg, setCurrentImg] = useState(null);
            const [imgLoadingText, setImgLoadingText] = useState(null);
            const [improvingSlide, setImprovingSlide] = useState(false);
            
            const [showLegal, setShowLegal] = useState(false);
            const [showCookieBanner, setShowCookieBanner] = useState(true);
            const [showKeyInput, setShowKeyInput] = useState(false);

            const chatRef = useRef(null);
            const chatEndRef = useRef(null);

            useEffect(() => { 
                if (chatEndRef.current) setTimeout(() => chatEndRef.current.scrollIntoView({ behavior: 'smooth' }), 100);
            }, [messages, loading]);

            const handleSaveKey = (key) => {
                setLocalApiKey(key);
                localStorage.setItem('gemini_key', key);
                setShowKeyInput(false);
            };

            const handleFile = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const base64 = ev.target.result;
                    if (type === 'vocab') setVocabFile(base64);
                    if (type === 'homework') setHomeworkFile(base64);
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const resetApp = () => {
                setMode("explain"); setTopic(""); setMessages([]); setInput(""); setLoading(false);
                setVocabFile(null); setHomeworkFile(null); setSlides([]); setSlideIdx(0);
                setCurrentImg(null); setImgLoadingText(null); setView("intro"); setPresLoadingProgress(null);
            };

            const startModule = async (newMode, startPrompt) => {
                if (!localApiKey) { setShowKeyInput(true); return; }
                if (!newMode) return;
                setMode(newMode); setView("classroom"); setLoading(true);
                let msgContent = startPrompt;
                let imgData = null;
                
                if (newMode === 'vocabulary' && vocabFile) { imgData = vocabFile.split(',')[1]; msgContent += " (Bildanalyse)"; setCurrentImg(vocabFile); } 
                else if ((newMode.includes('homework') || newMode==='correction') && homeworkFile) { imgData = homeworkFile.split(',')[1]; msgContent += " (Blatt)"; setCurrentImg(homeworkFile); } 
                else {
                    setImgLoadingText("Suche Bild...");
                    searchInternetImageSmart(topic, setImgLoadingText, localApiKey).then(img => { if(img) setCurrentImg(img); setImgLoadingText(null); });
                }
                
                const response = await generateContent([], msgContent, imgData, newMode, localApiKey);
                setMessages([{ role: "model", parts: [{ text: response }] }]);
                setLoading(false);
            };

            const createPresentation = async () => {
                if (!localApiKey) { setShowKeyInput(true); return; }
                if (!topic) return;
                setMode("presentation"); setView("classroom"); setLoading(true); setPresLoadingProgress("Strukturiere Inhalt...");
                const prompt = `Thema: ${topic}. Design: ${presSettings.design}. Folien: ${presSettings.count}.`;
                const json = await generateContent([], prompt, null, "presentation", localApiKey);
                
                if (!json || json.startsWith("Fehler") || json.startsWith("Verbindungsfehler")) { setMessages([{ role: "model", parts: [{ text: json || "Fehler." }] }]); setLoading(false); setPresLoadingProgress(null); return; }

                try {
                    const parsedSlides = JSON.parse(json);
                    setSlides(parsedSlides);
                    for (let i = 0; i < parsedSlides.length; i++) {
                        const slide = parsedSlides[i];
                        if (slide.layout.includes('image') && slide.imagePrompt) {
                            setPresLoadingProgress(`Folie ${i + 1}: Suche & Prüfe Bild...`);
                            const img = await searchInternetImageSmart(slide.imagePrompt, null, localApiKey); 
                            parsedSlides[i].imageUrl = img;
                        }
                    }
                    setSlides(parsedSlides); setSlideIdx(0); setPresLoadingProgress(null);
                } catch (e) { setMessages([{ role: "model", parts: [{ text: "Fehlerhafte Daten." }] }]); }
                setLoading(false);
            };

            const handleSlideChange = (newIdx) => { if (newIdx >= 0 && newIdx < slides.length) setSlideIdx(newIdx); };
            const downloadPPTX = async () => {
                const PptxGenJS = await loadPptxLib(); const pres = new PptxGenJS(); pres.layout = 'LAYOUT_16x9';
                const colors = { modern: '1e293b', chalkboard: 'FFFFFF', cyber: '22d3ee', book: '451a03', business: '0f172a', geometric: '312e81', space: 'e2e8f0' };
                const bgs = { modern: 'FFFFFF', chalkboard: '064E3B', cyber: '020617', book: 'fff7ed', business: 'F1F5F9', geometric: 'eef2ff', space: '0B0D17' };
                const c = colors[presSettings.design] || colors.modern; const bg = bgs[presSettings.design] || bgs.modern;
                slides.forEach(slide => {
                    const s = pres.addSlide(); s.background = { color: bg };
                    s.addText(slide.title, { x:0.5, y:0.4, w:'90%', h:0.8, fontSize:28, bold:true, color:c, align: slide.layout==='title_only'?'center':'left' });
                    if (slide.layout !== 'title_only') {
                        const textX = slide.layout === 'image_left' ? 5.5 : 0.5; const imgX = slide.layout === 'image_left' ? 0.5 : 5.5;
                        if (slide.content) s.addText(slide.content.map(t=>({text:t})), { x:textX, y:1.4, w:4.5, h:4, fontSize:18, color:c, bullet:true });
                        if (slide.imageUrl) s.addImage({ path:slide.imageUrl, x:imgX, y:1.4, w:4.3, h:3.5 });
                    }
                    if(slide.flashcard) s.addNotes(slide.flashcard);
                });
                pres.writeFile({ fileName: `Praesentation_${topic}.pptx` });
            };

            const DESIGNS_CONFIG = {
                modern: { name: 'Modern (Blau)', bg: 'bg-white', text: 'text-slate-800', accent: 'text-blue-600', border: 'border-slate-200', font: 'font-sans' },
                business: { name: 'Business (Grau)', bg: 'bg-slate-100', text: 'text-slate-900', accent: 'text-slate-600', border: 'border-slate-300', font: 'font-sans' },
                chalkboard: { name: 'Tafel (Grün)', bg: 'bg-emerald-900', text: 'text-white', accent: 'text-yellow-400', border: 'border-yellow-700/50', font: 'font-serif' },
                cyber: { name: 'Cyber (Neon)', bg: 'bg-slate-950', text: 'text-cyan-400', accent: 'text-fuchsia-500', border: 'border-cyan-500/50', font: 'font-mono' },
                book: { name: 'Buch (Antik)', bg: 'bg-amber-50', text: 'text-stone-800', accent: 'text-amber-900', border: 'border-stone-300', font: 'font-serif' },
                geometric: { name: 'Geometrisch (Lila)', bg: 'bg-indigo-50', text: 'text-indigo-900', accent: 'text-indigo-600', border: 'border-indigo-200', font: 'font-sans' },
                space: { name: 'Weltraum (Dunkel)', bg: 'bg-[#0B0D17]', text: 'text-slate-200', accent: 'text-indigo-400', border: 'border-indigo-900', font: 'font-sans' },
            };
            const dObj = DESIGNS_CONFIG[presSettings.design] || DESIGNS_CONFIG.modern;

            if (view === "intro") {
                return (
                    <div className="h-dvh bg-slate-950 text-white flex flex-col font-sans overflow-y-auto">
                        <div className="fixed inset-0 bg-gradient-to-br from-indigo-900 via-slate-950 to-purple-950 opacity-80 -z-10"></div>
                        <div className="z-10 flex flex-col items-center pt-10 pb-6 px-4 animate-fade-in-up">
                            <div className="inline-block p-5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-3xl shadow-2xl mb-4 hover:scale-105 transition-transform"><Icon name="GraduationCap" size={56} className="text-white" /></div>
                            <h1 className="text-4xl md:text-6xl font-black bg-clip-text text-transparent bg-gradient-to-r from-white via-indigo-100 to-purple-200 drop-shadow-lg text-center">SchulSim AI 4.6</h1>
                            <p className="text-indigo-300 font-bold tracking-[0.4em] text-xs uppercase mt-2">GitHub Secrets Edition • Created by Kayden</p>
                            
                            {/* KEY INPUT BUTTON */}
                            <button onClick={() => setShowKeyInput(true)} className={`mt-6 flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold transition-all ${localApiKey ? 'bg-green-900/50 text-green-300 border border-green-500/50' : 'bg-red-900/50 text-red-200 border border-red-500/50 animate-pulse'}`}>
                                <Icon name={localApiKey ? "CheckCircle" : "AlertTriangle"} size={16} /> 
                                {localApiKey ? "API Key aktiv" : "API Key eingeben (Erforderlich!)"}
                            </button>
                        </div>

                        <div className="z-10 w-full max-w-7xl px-4 pb-24 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mx-auto animate-fade-in-up">
                            {[{ id: 'explain', icon: 'Brain', color: 'blue', title: 'Verstehen', act: () => startModule('explain', `Erkläre: ${topic}`) },
                              { id: 'vocab', icon: 'Languages', color: 'pink', title: 'Vokabeln', act: () => startModule('vocabulary', `Vokabeln: ${topic}`), hasFile: true },
                              { id: 'homework', icon: 'PenTool', color: 'emerald', title: 'Aufgaben', act: (sub) => startModule(sub, sub==='homework_solve'?'Löse:': 'Hilf bei:'), hasFile: true, subs: [['homework_help','Hilfe'],['correction','Korr.'],['homework_solve','Lösen']] },
                              { id: 'pres', icon: 'Presentation', color: 'orange', title: 'Präsentation', special: true }
                            ].map((card) => (
                                <div key={card.id} className={`bg-white/5 backdrop-blur-xl border border-white/10 p-6 rounded-3xl hover:bg-white/10 transition-all flex flex-col shadow-2xl ${card.special ? 'lg:col-span-1 border-orange-500/30' : ''}`}>
                                    <div className={`flex items-center gap-3 mb-4 text-${card.color}-400`}><Icon name={card.icon} size={28} /> <h3 className="font-bold text-xl text-white">{card.title}</h3></div>
                                    {card.special ? (
                                        <div className="space-y-3 mt-auto">
                                            <div className="flex gap-2">
                                                <select className="bg-black/40 rounded-xl px-3 py-2 text-xs flex-1 outline-none text-white border border-white/10" onChange={e=>setPresSettings({...presSettings, design:e.target.value})}>{Object.keys(DESIGNS_CONFIG).map(d => <option key={d} value={d}>{DESIGNS_CONFIG[d].name}</option>)}</select>
                                                <select className="bg-black/40 rounded-xl px-3 py-2 text-xs w-20 outline-none text-white border border-white/10" onChange={e=>setPresSettings({...presSettings, count:e.target.value})}>{[3,5,7,10].map(n => <option key={n} value={n}>{n}</option>)}</select>
                                            </div>
                                            <div className="flex gap-2 bg-black/40 p-1 rounded-xl items-center justify-center text-xs text-slate-300">
                                                <Icon name="Globe" size={12} className="mr-1"/> Bilder: Internet (Smart)
                                            </div>
                                            <input className="w-full bg-black/40 rounded-xl px-4 py-3 text-sm text-white outline-none border border-white/10 focus:border-orange-500" placeholder="Thema..." value={topic} onChange={e=>setTopic(e.target.value)} />
                                            <button onClick={createPresentation} disabled={!topic} className="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded-xl font-bold text-sm text-white shadow-lg flex items-center justify-center gap-2"><Icon name="Play" size={14}/> Erstellen</button>
                                        </div>
                                    ) : (
                                        <div className="mt-auto space-y-3">
                                            {card.hasFile && (
                                                <div className="relative">
                                                    {((card.id === 'vocab' && vocabFile) || (card.id === 'homework' && homeworkFile)) ? (
                                                        <div className="flex items-center gap-2 text-xs text-green-300 bg-green-900/30 p-3 rounded-xl border border-green-500/30"><Icon name="CheckCircle" size={16} /> Bild bereit <button onClick={() => card.id==='vocab'?setVocabFile(null):setHomeworkFile(null)} className="ml-auto hover:text-white"><Icon name="XCircle" size={14}/></button></div>
                                                    ) : (<label className="flex items-center justify-center gap-2 w-full py-3 border border-dashed border-slate-500 rounded-xl text-slate-300 text-xs cursor-pointer hover:border-white hover:text-white bg-black/20"><Icon name="Upload" size={16} /> Bild laden<input type="file" accept="image/*" className="hidden" onChange={(e) => handleFile(e, card.id)} /></label>)}
                                                </div>
                                            )}
                                            {card.subs && <div className="flex gap-2 bg-black/30 p-1.5 rounded-xl">{card.subs.map(([k, l]) => <button key={k} onClick={() => {if(topic||homeworkFile) card.act(k)}} className="flex-1 py-2 text-[10px] font-bold rounded-lg hover:bg-white/10 text-slate-300 hover:text-white uppercase">{l}</button>)}</div>}
                                            <input className={`w-full bg-black/40 rounded-xl px-4 py-3 text-sm text-white outline-none border border-white/10 focus:border-${card.color}-500`} placeholder={card.id==='homework'?"Aufgabe...":"Thema..."} value={topic} onChange={e=>setTopic(e.target.value)} />
                                            {!card.subs && <button onClick={card.act} disabled={!topic && !vocabFile} className={`w-full bg-${card.color}-600 hover:bg-${card.color}-500 py-3 rounded-xl font-bold text-sm text-white shadow-lg`}>Starten</button>}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                        
                        <div className="w-full text-center pb-8 mt-auto z-10">
                           <button onClick={() => setShowLegal(true)} className="text-[10px] text-slate-500 hover:text-white transition-colors">Rechtliches & Impressum</button>
                        </div>

                        {/* KEY INPUT MODAL */}
                        {showKeyInput && (
                            <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
                                <div className="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                    <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Icon name="Key" className="text-yellow-400"/> API Key Setup</h2>
                                    <p className="text-sm text-slate-400 mb-4">
                                        Damit die App funktioniert, benötigst du einen kostenlosen Google Gemini API Key.
                                        Der Key wird nur in deinem Browser gespeichert.
                                    </p>
                                    <input 
                                        type="password" 
                                        placeholder="AIzaSy..." 
                                        className="w-full bg-black/50 border border-slate-600 rounded-lg px-4 py-3 text-white mb-4 focus:border-indigo-500 outline-none"
                                        onKeyDown={(e) => { if(e.key === 'Enter') handleSaveKey(e.target.value) }}
                                    />
                                    <div className="flex gap-2">
                                        <a href="https://aistudio.google.com/app/apikey" target="_blank" className="flex-1 text-center py-2 text-sm text-indigo-400 hover:text-indigo-300 border border-indigo-900 rounded-lg">Key holen ↗</a>
                                        <button onClick={(e) => handleSaveKey(e.target.previousSibling.previousSibling.value)} className="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-lg font-bold">Speichern</button>
                                    </div>
                                    <button onClick={() => setShowKeyInput(false)} className="w-full mt-4 text-xs text-slate-500 hover:text-white">Abbrechen</button>
                                </div>
                            </div>
                        )}

                        {showCookieBanner && (
                          <div className="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-700 p-4 z-50 flex flex-col md:flex-row items-center justify-between gap-4 shadow-2xl">
                            <div className="flex items-center gap-3"><div className="p-2 bg-blue-500/20 rounded-full text-blue-400"><Icon name="Cookie" size={20} /></div><p className="text-xs text-slate-300">Wir verwenden Cookies (für den API Key), um Ihre Erfahrung zu verbessern.</p></div>
                            <div className="flex gap-2"><button onClick={() => setShowCookieBanner(false)} className="text-xs text-slate-400 hover:text-white px-3 py-1.5">Einstellungen</button><button onClick={() => setShowCookieBanner(false)} className="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-lg font-bold">Akzeptieren</button></div>
                          </div>
                        )}

                        {showLegal && (
                          <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-900 border border-slate-700 w-full max-w-3xl max-h-[85vh] rounded-2xl flex flex-col shadow-2xl relative">
                              <div className="p-6 border-b border-slate-800 flex justify-between items-center sticky top-0 bg-slate-900 rounded-t-2xl z-10"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Icon name="Scale" className="text-indigo-400"/> Rechtliche Hinweise</h2><button onClick={() => setShowLegal(false)} className="text-slate-400 hover:text-white"><Icon name="XCircle" /></button></div>
                              <div className="p-6 overflow-y-auto space-y-8 text-sm text-slate-300">
                                <section><h3 className="font-bold text-white mb-2 flex items-center gap-2"><Icon name="FileText" size={16}/> Impressum (§ 5 DDG)</h3><p>Kayden Schunack<br/>Kontakt: didskanal@gmail.com</p></section>
                                <section><h3 className="font-bold text-white mb-2 flex items-center gap-2"><Icon name="Lock" size={16}/> Datenschutz</h3><p>Keine dauerhafte Speicherung personenbezogener Daten.</p></section>
                                <section>
                                  <h3 className="font-bold text-white mb-2 flex items-center gap-2"><Icon name="FileCheck" size={16}/> Pflichtangaben</h3>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     {['Cookie-Consent','Barrierefreiheit','Widerrufsbelehrung','AGB','Quellennachweise','SSL-Verschlüsselung','Jugendschutz'].map(t=><div key={t} className="p-3 bg-slate-800 rounded border border-slate-700 flex items-center gap-2"><Icon name="CheckCircle" size={14} className="text-green-500"/> {t}</div>)}
                                  </div>
                                </section>
                              </div>
                              <div className="p-4 border-t border-slate-800 bg-slate-900 rounded-b-2xl sticky bottom-0"><button onClick={() => setShowLegal(false)} className="w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg font-bold border border-slate-700">Schließen</button></div>
                            </div>
                          </div>
                        )}
                    </div>
                );
            }

            return (
                <div className="h-dvh bg-slate-950 flex flex-col md:flex-row font-sans overflow-hidden text-slate-100">
                    {loading && mode === 'presentation' && (
                        <div className="absolute inset-0 z-50 bg-slate-900/95 backdrop-blur-xl flex flex-col items-center justify-center text-center">
                            <Icon name="RefreshCw" size={48} className="text-orange-500 animate-spin mb-6" />
                            <h2 className="text-2xl font-bold text-white mb-2">Erstelle Präsentation...</h2>
                            <p className="text-slate-400 animate-pulse">{presLoadingProgress || "Strukturiere Inhalte..."}</p>
                        </div>
                    )}

                    <div className="w-full md:w-1/2 flex flex-col border-r border-white/5 bg-[#0F1115] relative shrink-0 h-[40%] md:h-full">
                        <div className="p-4 border-b border-white/5 flex justify-between items-center bg-[#0F1115]">
                            <h2 className="font-bold text-indigo-300 flex items-center gap-2">{mode === 'presentation' ? <Icon name="Presentation" size={18} /> : <Icon name="BookOpen" size={18} />} {mode === 'presentation' ? "Vorschau" : "Visuelle Tafel"}</h2>
                            {mode === 'presentation' && slides.length > 0 && <span className="text-xs font-mono bg-white/10 px-2 py-1 rounded text-slate-300">Folie {slideIdx+1}/{slides.length}</span>}
                        </div>
                        <div className="flex-1 flex items-center justify-center p-4 bg-[#0a0a0c] relative overflow-hidden">
                            {mode === 'presentation' && slides.length > 0 ? (
                                <div className={`relative w-full aspect-video ${dObj.bg} ${dObj.text} ${dObj.font} rounded-xl shadow-2xl overflow-hidden flex flex-col transition-all duration-500 border-4 border-white/5`}>
                                    <div className="flex-1 p-2 md:p-8 flex flex-col relative z-10">
                                        <h2 className={`text-xl md:text-3xl font-bold mb-2 md:mb-6 ${dObj.accent} border-b ${dObj.border} pb-2 md:pb-4 leading-tight`}>{slides[slideIdx].title}</h2>
                                        <div className={`flex flex-1 gap-2 md:gap-8 ${slides[slideIdx].layout === 'image_left' ? 'flex-row-reverse' : 'flex-row'} items-center`}>
                                            {slides[slideIdx].layout !== 'title_only' && (<div className={`${slides[slideIdx].layout?.includes('image') ? 'w-1/2' : 'w-full'} overflow-y-auto max-h-full pr-1 md:pr-2`}><ul className="space-y-1 md:space-y-4">{slides[slideIdx].content?.map((pt, i) => (<li key={i} className="flex gap-2 md:gap-3 text-xs md:text-lg items-start leading-snug"><span className={`${dObj.accent} text-lg md:text-2xl leading-none`}>•</span><span className="opacity-90">{pt}</span></li>))}</ul></div>)}
                                            {(slides[slideIdx].layout?.includes('image')) && (<div className="w-1/2 h-full bg-black/5 rounded-lg overflow-hidden relative shadow-inner flex items-center justify-center">{slides[slideIdx].imageUrl ? (<img src={slides[slideIdx].imageUrl} className="relative z-10 w-full h-full object-contain" alt="Slide" />) : (<div className="text-center opacity-30"><Icon name="ImageIcon" size={48} className="mx-auto mb-2"/><span className="text-xs font-bold uppercase">Kein Bild</span></div>)}</div>)}
                                        </div>
                                    </div>
                                    <div className="absolute bottom-4 right-4 flex gap-2 z-20">
                                        <button onClick={() => handleSlideChange(Math.max(0, slideIdx-1))} disabled={slideIdx===0} className="p-2 bg-black/50 text-white rounded hover:bg-black/70 disabled:opacity-30 backdrop-blur-md"><Icon name="ChevronLeft" size={20}/></button>
                                        <button onClick={() => handleSlideChange(Math.min(slides.length-1, slideIdx+1))} disabled={slideIdx===slides.length-1} className="p-2 bg-black/50 text-white rounded hover:bg-black/70 disabled:opacity-30 backdrop-blur-md"><Icon name="ChevronRight" size={20}/></button>
                                        <button onClick={downloadPPTX} className="px-4 py-2 bg-orange-600 text-white text-xs font-bold rounded hover:bg-orange-500 shadow-lg flex items-center gap-2"><Icon name="Download" size={14}/> PPTX</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="relative max-w-lg w-full aspect-square flex items-center justify-center border-2 border-dashed border-slate-700/50 rounded-3xl bg-slate-900/50 backdrop-blur-sm">
                                    {imgLoadingText ? (<div className="text-center text-indigo-400 animate-pulse"><Icon name="RefreshCw" size={48} className="animate-spin mx-auto mb-4"/><p className="font-medium">{imgLoadingText}</p></div>) : currentImg ? (<img src={currentImg} className="w-full h-full object-contain rounded-2xl shadow-2xl bg-slate-800" />) : (<div className="text-center text-slate-600"><Icon name="ImageIcon" size={48} className="mx-auto mb-2 opacity-50"/><p>Tafel leer</p></div>)}
                                </div>
                            )}
                        </div>
                        {mode === 'presentation' && slides.length > 0 && (<div className="h-24 bg-[#0a0a0c] border-t border-white/5 flex gap-2 p-2 overflow-x-auto items-center">{slides.map((s, i) => (<div key={i} onClick={() => setSlideIdx(i)} className={`h-full aspect-video rounded border-2 cursor-pointer transition-all relative overflow-hidden ${i === slideIdx ? 'border-indigo-500 opacity-100 scale-105' : 'border-transparent opacity-50 hover:opacity-80'}`}><div className={`w-full h-full ${dObj.bg} p-1 text-[4px] leading-none text-slate-900 overflow-hidden`}><div className="font-bold mb-1 truncate">{s.title}</div>{s.imageUrl && <div className="w-full h-1/2 bg-slate-200 mt-1 rounded-sm opacity-50"></div>}</div></div>))}</div>)}
                    </div>

                    <div className="w-full md:w-1/2 flex flex-col bg-slate-950 border-l border-white/5 relative min-h-0 h-[60%] md:h-full">
                        <div className="p-4 border-b border-white/5 flex justify-between items-center bg-slate-900 shadow-lg z-10 shrink-0">
                            <div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${mode==='presentation'?'bg-orange-600':'bg-indigo-600'}`}>{mode==='presentation' ? <Icon name="StickyNote" size={16} className="text-white"/> : <Icon name="GraduationCap" size={16} className="text-white"/>}</div><div><h3 className="font-bold text-white text-sm">{mode==='presentation' ? 'Sprechertext' : 'Herr Lehrer'}</h3><div className="flex items-center gap-1.5"><span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span><span className="text-[10px] text-slate-400">Online</span></div></div></div>
                            <button onClick={resetApp} className="text-[10px] font-bold text-slate-500 hover:text-red-400 bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700 transition-colors">BEENDEN</button>
                        </div>

                        {mode === 'presentation' && slides.length > 0 ? (
                            <div className="flex-1 flex flex-col min-h-0">
                                <div className="flex-1 p-4 md:p-8 overflow-y-auto flex flex-col items-center bg-slate-950">
                                    <div className="w-full max-w-md bg-[#FEF3C7] text-slate-800 p-6 rounded-lg shadow-2xl rotate-1 mb-4 border-t-8 border-yellow-400 relative">
                                        <div className="absolute top-4 right-4 text-[#F59E0B]/50"><Icon name="Mic" size={24} /></div>
                                        <h4 className="font-bold text-xs uppercase tracking-widest text-slate-500 mb-4 border-b border-slate-300 pb-2">Sprechertext: Folie {slideIdx+1}</h4>
                                        <p className="font-serif text-sm md:text-xl leading-relaxed whitespace-pre-wrap">{slides[slideIdx].flashcard || "Keine Notizen verfügbar."}</p>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col relative min-h-0">
                                <div ref={chatRef} className="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`flex ${m.role==='model'?'justify-start':'justify-end'} animate-in slide-in-from-bottom-2 fade-in duration-300`}>
                                            <div className={`max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed shadow-md ${m.role==='model'?'bg-slate-800 text-slate-200 rounded-tl-none border border-slate-700':'bg-indigo-600 text-white rounded-tr-none'}`}><Typewriter text={m.parts[0].text} /></div>
                                        </div>
                                    ))}
                                    {loading && <div className="flex justify-start"><div className="bg-slate-800 p-4 rounded-2xl rounded-tl-none flex gap-1.5 border border-slate-700 items-center"><div className="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce"></div><div className="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-75"></div><div className="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce delay-150"></div></div></div>}
                                    <div ref={chatEndRef} />
                                </div>
                                <div className="p-4 border-t border-white/5 bg-slate-900 absolute bottom-0 w-full z-20">
                                    <div className="relative flex items-center bg-slate-950 rounded-full border border-slate-700 px-2 py-1 shadow-inner focus-within:border-indigo-500 transition-colors">
                                        <input className="flex-1 bg-transparent text-white px-4 py-3 outline-none text-sm placeholder-slate-600" placeholder="Deine Nachricht..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&(() => { const newMsg = [...messages, {role:'user', parts:[{text:input}]}]; setMessages(newMsg); setInput(''); setLoading(true); generateContent(newMsg, input, null, mode, localApiKey).then(r => { setMessages(p => [...p, {role:'model', parts:[{text:r}]}]); setLoading(false); }); })()} />
                                        <button className="bg-indigo-600 hover:bg-indigo-500 p-2.5 rounded-full text-white transition-colors shadow-lg disabled:opacity-50 disabled:scale-95 transform" disabled={!input.trim()} onClick={() => { const newMsg = [...messages, {role:'user', parts:[{text:input}]}]; setMessages(newMsg); setInput(''); setLoading(true); generateContent(newMsg, input, null, mode, localApiKey).then(r => { setMessages(p => [...p, {role:'model', parts:[{text:r}]}]); setLoading(false); }); }}><Icon name="Send" size={18}/></button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
