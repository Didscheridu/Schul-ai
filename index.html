<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SchulSim AI 6.3 (Trifecta)</title>
    
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nexus: { 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #e2e8f0; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); }
        .glass:hover { background: rgba(51, 65, 85, 0.9); border-color: rgba(99, 102, 241, 0.5); transform: translateY(-2px); transition: all 0.3s ease; }
        .slide-preview ul { list-style-type: none; padding-left: 0; }
        .slide-preview li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .slide-preview li::before { content: "•"; color: #3b82f6; font-weight: bold; position: absolute; left: 0; }
        .h-dvh { height: 100dvh; }
        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="m-0 p-0 overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        // =================================================================
        // API KEY AUFTEILUNG (Security durch Obfuscation)
        // =================================================================
        
        // Teil 1 des Keys (z.B. "AIzaSy...")
        const PART_A = "AIzaSyCb4nqo"; 
        
        // Teil 2 des Keys (Mittelteil)
        const PART_B = "ilymX4lPn9EO"; 
        
        // Teil 3 des Keys (Endstück)
        const PART_C = "UsZq-gAWDSIInKo"; 

        // =================================================================

        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={path} /></svg>
        );

        const ICONS = {
            Brain: "M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10 10 10 0 0 1-10-10 10 10 0 0 1 10-10z M9.5 8a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1-5 0z", 
            Book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z",
            Pen: "M12 19l7-7 3 3-7 7-3-3z M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z",
            Pres: "M2 3h20v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3m5 18l5-5 5 5",
            Send: "M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z",
            Upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",
            Check: "M20 6L9 17l-5-5",
            Download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
            Left: "M15 18l-6-6 6-6",
            Right: "M9 18l6-6 6-6",
            Search: "M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z",
            Image: "M18 3H6a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V6a3 3 0 0 0-3-3zM6 8l4 4 4-4 4 4M14 14l-4 4-4-4",
            Alert: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01"
        };

        // --- CORE LOGIC ---

        const getApiKey = () => {
            const key = (PART_A + PART_B + PART_C).trim();
            // Fallback auf LocalStorage für Entwickler-Tests
            if (!key) return localStorage.getItem("schulsim_key") || "";
            return key;
        };

        const searchImage = async (query) => {
            const clean = query.replace(/bild von|foto von|zeige/gi, '').trim();
            // 1. Versuch: Wikimedia
            try {
                const url = `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrnamespace=6&gsrsearch=${encodeURIComponent(clean)}&gsrlimit=3&prop=imageinfo&iiprop=url&format=json&origin=*`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.query?.pages) {
                    // Nimm das erste Bild, das kein SVG ist (oft Icons), wenn möglich
                    const pages = Object.values(data.query.pages);
                    const best = pages.find(p => p.imageinfo?.[0]?.url && !p.imageinfo[0].url.endsWith('.svg')) || pages[0];
                    if (best?.imageinfo?.[0]?.url) return best.imageinfo[0].url;
                }
            } catch (e) { console.error(e); }
            // 2. Fallback: Pollinations (Unlimitiert)
            return `https://image.pollinations.ai/prompt/${encodeURIComponent(clean)}?width=1024&height=768&nologo=true&seed=${Math.random()}`;
        };

        const callAI = async (prompt, systemPrompt, imageData) => {
            const key = getApiKey();
            if (!key) return "FEHLER: API Key fehlt. Bitte Code prüfen.";

            const parts = [{ text: prompt }];
            if (imageData) parts.push({ inlineData: { mimeType: "image/png", data: imageData } });

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: systemPrompt }] }, { role: "user", parts }]
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    return `API Fehler (${res.status}): ${err.error?.message || "Unbekannt"}`;
                }

                const data = await res.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Keine Antwort.";
                
                // Cleanup
                text = text.replace(/```json|```/g, '').trim();
                text = text.replace(/\$\$/g, '').replace(/\\\[/g, '').replace(/\\\]/g, ''); 
                
                return text;
            } catch (e) {
                return `Verbindungsfehler: ${e.message}`;
            }
        };

        // --- COMPONENTS ---

        const Typewriter = ({ text }) => {
            const [d, setD] = useState('');
            useEffect(() => {
                setD('');
                let i = 0;
                const t = setInterval(() => {
                    if (i < text.length) { setD(p => p + text.charAt(i)); i++; } else clearInterval(t);
                }, 3);
                return () => clearInterval(t);
            }, [text]);
            return <span className="whitespace-pre-wrap">{d.split('**').map((s,i) => i%2===1 ? <strong key={i} className="text-blue-400">{s}</strong> : s)}</span>;
        };

        const App = () => {
            const [view, setView] = useState("intro");
            const [mode, setMode] = useState("explain");
            const [topic, setTopic] = useState("");
            const [chat, setChat] = useState([]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState(""); // Lade-Text
            const [imgUrl, setImgUrl] = useState(null);
            const [fileData, setFileData] = useState(null);
            
            // Presentation
            const [slides, setSlides] = useState([]);
            const [slideIdx, setSlideIdx] = useState(0);
            const [presOpts, setPresOpts] = useState({ count: 5, style: 'Modern' });

            const chatEnd = useRef(null);
            useEffect(() => chatEnd.current?.scrollIntoView({ behavior: 'smooth' }), [chat, loading]);

            const handleFile = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = (ev) => setFileData(ev.target.result);
                r.readAsDataURL(f);
                e.target.value = "";
            };

            const startAction = async (newMode, subPrompt = null) => {
                if (!topic && !fileData && newMode !== 'homework_help') {
                    alert("Bitte gib ein Thema ein oder lade ein Bild hoch!");
                    return;
                }
                
                setMode(newMode);
                setView("classroom");
                setChat([]);
                setSlides([]);
                setImgUrl(null);
                setLoading(true);

                let mainPrompt = topic;
                let sysPrompt = "";

                // --- 1. PRÄSENTATION ---
                if (newMode === 'presentation') {
                    setStatus("Erstelle Struktur...");
                    sysPrompt = `Erstelle JSON für Präsentation (${presOpts.count} Folien). Format: [{"title":"", "content":[""], "imageQuery":"", "speakerNotes":""}]. Thema: ${topic}.`;
                    
                    const res = await callAI(topic, sysPrompt, null, getApiKey());
                    
                    try {
                        const jsonStr = res.match(/\[[\s\S]*\]/)?.[0] || "[]";
                        const parsed = JSON.parse(jsonStr);
                        setSlides(parsed);
                        
                        // Bilder laden
                        const slidesWithImg = [...parsed];
                        for(let i=0; i<slidesWithImg.length; i++) {
                            if(slidesWithImg[i].imageQuery) {
                                setStatus(`Lade Bild ${i+1}/${slidesWithImg.length}...`);
                                slidesWithImg[i].imageUrl = await searchImage(slidesWithImg[i].imageQuery);
                            }
                        }
                        setSlides(slidesWithImg);
                    } catch (e) {
                        setChat([{ role: 'model', text: "Fehler beim Erstellen der Folien: " + e.message }]);
                    }
                } 
                // --- 2. ANDERE MODI ---
                else {
                    if (subPrompt) mainPrompt = `${subPrompt} ${topic}`;
                    
                    // Bild laden (wenn nicht Datei-Upload)
                    if (!fileData && newMode !== 'chat_only') {
                        setStatus("Suche Bild...");
                        searchImage(topic).then(url => { setImgUrl(url); setStatus(null); });
                    } else if (fileData) {
                        setImgUrl(fileData);
                    }

                    // Text generieren
                    setStatus("KI schreibt...");
                    if (newMode === 'vocab') sysPrompt = "Vokabeltrainer. Erstelle eine Tabelle oder frage ab.";
                    else if (newMode === 'homework_solve') sysPrompt = "Löse die Aufgabe direkt und verständlich.";
                    else sysPrompt = "Erkläre das Thema als Lehrer. Nutze Markdown.";

                    const res = await callAI(mainPrompt, sysPrompt, fileData?.split(',')[1], getApiKey());
                    setChat([{ role: 'model', text: res }]);
                }
                
                setLoading(false);
                setStatus("");
            };

            const sendMessage = async () => {
                if(!input.trim()) return;
                const newChat = [...chat, { role: 'user', text: input }];
                setChat(newChat);
                setInput("");
                setLoading(true);
                const res = await callAI(input, "Du bist ein Tutor. Antworte hilfreich.", null, getApiKey());
                setChat([...newChat, { role: 'model', text: res }]);
                setLoading(false);
            };

            const downloadPPT = () => {
                if(!window.PptxGenJS) return;
                const pres = new window.PptxGenJS();
                slides.forEach(s => {
                    const sl = pres.addSlide();
                    sl.addText(s.title, { x:0.5, y:0.5, fontSize:24, bold:true, color:'363636' });
                    sl.addText(s.content, { x:0.5, y:1.5, w:'50%', fontSize:16, color:'363636', bullet:true });
                    if(s.imageUrl) sl.addImage({ path:s.imageUrl, x:5.5, y:1.5, w:4, h:3 });
                    if(s.speakerNotes) sl.addNotes(s.speakerNotes);
                });
                pres.writeFile({ fileName: `Praesentation_${topic}.pptx` });
            };

            // --- UI RENDER ---
            if (view === 'intro') {
                return (
                    <div className="h-dvh flex flex-col items-center justify-center p-6 bg-slate-950 text-white relative overflow-hidden">
                        {/* Background */}
                        <div className="absolute inset-0 bg-gradient-to-br from-blue-900 to-slate-950 -z-10 animate-pulse-slow"></div>
                        
                        <div className="z-10 max-w-5xl w-full text-center">
                             <h1 className="text-6xl font-black mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">SchulSim AI 6.3</h1>
                             <p className="text-slate-400 mb-10 font-bold tracking-widest text-xs uppercase">Trifecta Core Edition • Created by Kayden</p>
                             
                             <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-left">
                                {/* Explain */}
                                <div className="glass p-6 rounded-2xl flex flex-col">
                                    <div className="flex items-center gap-2 mb-4 text-blue-400"><Icon path={ICONS.Brain} /> <span className="font-bold text-white">Verstehen</span></div>
                                    <div className="mt-auto space-y-2">
                                        <button onClick={()=>startAction('explain', 'Erkläre mir:')} className="w-full bg-white/10 hover:bg-white/20 py-1.5 rounded text-xs font-bold">Erklären</button>
                                        <button onClick={()=>startAction('explain', 'Ich habe eine Frage zu:')} className="w-full bg-white/10 hover:bg-white/20 py-1.5 rounded text-xs font-bold">Frage</button>
                                        <input className="w-full bg-black/40 rounded px-3 py-2 text-sm border border-white/10" placeholder="Thema..." value={topic} onChange={e=>setTopic(e.target.value)} />
                                    </div>
                                </div>

                                {/* Vocab */}
                                <div className="glass p-6 rounded-2xl flex flex-col">
                                    <div className="flex items-center gap-2 mb-4 text-pink-400"><Icon path={ICONS.Book} /> <span className="font-bold text-white">Vokabeln</span></div>
                                    <div className="mt-auto space-y-2">
                                        <label className="w-full border border-dashed border-slate-600 rounded py-2 flex justify-center items-center gap-2 text-xs cursor-pointer hover:bg-white/5">
                                            <Icon path={fileData ? ICONS.Check : ICONS.Upload} size={14}/> {fileData ? "Bild OK" : "Upload"}
                                            <input type="file" hidden accept="image/*" onChange={handleFile} />
                                        </label>
                                        <input className="w-full bg-black/40 rounded px-3 py-2 text-sm border border-white/10" placeholder="Sprache..." value={topic} onChange={e=>setTopic(e.target.value)} />
                                        <button onClick={()=>startAction('vocab')} className="w-full bg-pink-600 hover:bg-pink-500 py-2 rounded text-xs font-bold shadow-lg">Start</button>
                                    </div>
                                </div>

                                {/* Homework */}
                                <div className="glass p-6 rounded-2xl flex flex-col">
                                    <div className="flex items-center gap-2 mb-4 text-emerald-400"><Icon path={ICONS.Pen} /> <span className="font-bold text-white">Aufgaben</span></div>
                                    <div className="mt-auto space-y-2">
                                        <label className="w-full border border-dashed border-slate-600 rounded py-2 flex justify-center items-center gap-2 text-xs cursor-pointer hover:bg-white/5">
                                            <Icon path={fileData ? ICONS.Check : ICONS.Upload} size={14}/> {fileData ? "Bild OK" : "Upload"}
                                            <input type="file" hidden accept="image/*" onChange={handleFile} />
                                        </label>
                                        <div className="flex gap-1">
                                            <button onClick={()=>startAction('homework_help')} className="flex-1 bg-white/10 py-1.5 rounded text-[10px]">HILFE</button>
                                            <button onClick={()=>startAction('homework_solve', 'Löse:')} className="flex-1 bg-emerald-600 py-1.5 rounded text-[10px] font-bold shadow">LÖSEN</button>
                                        </div>
                                        <input className="w-full bg-black/40 rounded px-3 py-2 text-sm border border-white/10" placeholder="Aufgabe..." value={topic} onChange={e=>setTopic(e.target.value)} />
                                    </div>
                                </div>

                                {/* Presentation */}
                                <div className="glass p-6 rounded-2xl flex flex-col border border-orange-500/30">
                                    <div className="flex items-center gap-2 mb-4 text-orange-400"><Icon path={ICONS.Pres} /> <span className="font-bold text-white">Referat</span></div>
                                    <div className="mt-auto space-y-2">
                                        <div className="flex gap-2">
                                            <select className="bg-black/40 rounded px-2 py-1 text-xs w-full outline-none" onChange={e=>setPresOpts({...presOpts, count: e.target.value})}>
                                                <option value="5">5 Folien</option><option value="8">8 Folien</option><option value="10">10 Folien</option>
                                            </select>
                                        </div>
                                        <input className="w-full bg-black/40 rounded px-3 py-2 text-sm border border-white/10" placeholder="Thema..." value={topic} onChange={e=>setTopic(e.target.value)} />
                                        <button onClick={()=>startAction('presentation')} className="w-full bg-orange-600 hover:bg-orange-500 py-2 rounded text-xs font-bold shadow-lg">Erstellen</button>
                                    </div>
                                </div>
                            </div>
                            
                            {!getApiKey() && (
                                <div className="mt-8 p-3 bg-red-500/20 border border-red-500 rounded text-red-200 text-xs flex items-center gap-2">
                                    <Icon path={ICONS.Alert} size={16}/> Achtung: API Key fehlt im Code! Bitte die 3 Teile in der Datei eintragen.
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-dvh flex flex-col md:flex-row bg-slate-950 text-white overflow-hidden">
                    {loading && (
                        <div className="absolute inset-0 z-50 bg-slate-900/90 backdrop-blur flex flex-col items-center justify-center">
                            <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <p className="animate-pulse font-bold">{status || "KI arbeitet..."}</p>
                        </div>
                    )}

                    {/* LEFT: VISUALS */}
                    <div className="h-[40%] md:h-full md:w-1/2 bg-[#0b0f19] border-r border-white/10 flex flex-col relative">
                        <div className="p-4 border-b border-white/5 flex justify-between items-center bg-slate-900/50">
                            <span className="font-bold text-blue-400 flex items-center gap-2"><Icon path={ICONS.Image} size={18}/> Tafel</span>
                            <button onClick={()=>window.location.reload()} className="text-xs bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1 rounded hover:bg-red-500/20 transition-colors">BEENDEN</button>
                        </div>
                        
                        <div className="flex-1 p-6 flex flex-col items-center justify-center relative overflow-hidden">
                            {mode === 'presentation' && slides.length > 0 ? (
                                <div className="w-full aspect-video bg-white text-slate-800 rounded-xl shadow-2xl p-6 flex flex-col overflow-hidden animate-float">
                                    <h2 className="text-2xl font-bold border-b-2 border-slate-200 pb-2 mb-4">{slides[slideIdx].title}</h2>
                                    <div className="flex flex-1 gap-4 overflow-hidden">
                                        <div className="flex-1 overflow-y-auto slide-preview"><ul className="space-y-2">{slides[slideIdx].content.map((c,i)=><li key={i}>{c}</li>)}</ul></div>
                                        {slides[slideIdx].imageUrl && <img src={slides[slideIdx].imageUrl} className="w-1/3 object-contain rounded bg-slate-100" />}
                                    </div>
                                    <div className="mt-2 flex justify-between items-center pt-2 border-t border-slate-100">
                                        <div className="flex gap-2">
                                            <button onClick={()=>setSlideIdx(Math.max(0, slideIdx-1))} className="p-1 hover:bg-slate-200 rounded"><Icon path={ICONS.Left} /></button>
                                            <button onClick={()=>setSlideIdx(Math.min(slides.length-1, slideIdx+1))} className="p-1 hover:bg-slate-200 rounded"><Icon path={ICONS.Right} /></button>
                                        </div>
                                        <button onClick={downloadPPTX} className="text-xs bg-orange-500 text-white px-3 py-1 rounded font-bold hover:bg-orange-600 transition-colors">PPTX</button>
                                    </div>
                                </div>
                            ) : (
                                currentImg ? <img src={currentImg} className="max-h-full max-w-full rounded-lg shadow-2xl object-contain" /> : 
                                <div className="text-slate-700 flex flex-col items-center"><Icon path={ICONS.Image} size={64}/><p className="mt-2 text-sm opacity-50">Leer</p></div>
                            )}
                        </div>
                    </div>

                    {/* RIGHT: CHAT */}
                    <div className="h-[60%] md:h-full md:w-1/2 bg-slate-950 flex flex-col relative">
                        <div className="p-4 border-b border-white/5 flex items-center gap-3">
                            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span className="font-bold text-sm text-slate-300">KI Tutor</span>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 space-y-4 pb-24">
                            {mode === 'presentation' && slides.length > 0 ? (
                                <div className="bg-yellow-50/10 border border-yellow-500/20 p-6 rounded-xl">
                                    <h4 className="text-xs text-yellow-400 font-bold uppercase mb-2">Sprecher-Notizen:</h4>
                                    <p className="text-slate-300 leading-relaxed whitespace-pre-wrap">{slides[slideIdx].flashcard}</p>
                                </div>
                            ) : (
                                messages.map((m, i) => (
                                    <div key={i} className={`flex ${m.role==='model'?'justify-start':'justify-end'}`}>
                                        <div className={`max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed shadow-lg ${m.role==='model'?'bg-slate-800 rounded-tl-none border border-white/5':'bg-blue-600 text-white rounded-tr-none'}`}>
                                            <Typewriter text={m.text} />
                                        </div>
                                    </div>
                                ))
                            )}
                            <div ref={chatEnd}></div>
                        </div>

                        {mode !== 'presentation' && (
                            <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-slate-950 via-slate-950 to-transparent">
                                <div className="flex items-center bg-slate-900 border border-white/10 rounded-full px-2 py-1 shadow-2xl focus-within:border-blue-500 transition-all">
                                    <input className="flex-1 bg-transparent px-4 py-3 outline-none text-sm" placeholder="Nachricht..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} />
                                    <button onClick={send} className="p-2 bg-blue-600 rounded-full text-white hover:bg-blue-500 transition-colors"><Icon path={ICONS.Send} size={18}/></button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
